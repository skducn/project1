# 1ä¸ªç”Ÿäº§è€… â†’ 1ä¸ªæ¶ˆè´¹è€…ï¼ˆ2ä¸ªä»»åŠ¡ï¼‰
# åŠŸèƒ½ï¼šæ¶ˆè´¹è€…ä»»åŠ¡1ä»ç”Ÿäº§è€…ä¸­è·å–Xcomå€¼ï¼Œå¤„ç†åï¼Œä¼ é€’ç»™ä»»åŠ¡2å¤„ç†

# åœºæ™¯ï¼š
# task1 (c_cdrd_TASK1) æ‰§è¡Œ â†’ è¿”å›å€¼è‡ªåŠ¨å­˜å‚¨åˆ°XCom
# task1 >> task2 ä¾èµ–å…³ç³»ç¡®ä¿é¡ºåº
# task2 (c_cdrd_TASK2) æ‰§è¡Œ â†’ ä»XComè·å–task1çš„è¿”å›å€¼ â†’ è¿›è¡Œåç»­å¤„ç†
# è¿™æ ·å°±å®ç°äº†ä»»åŠ¡é—´çš„æ•°æ®ä¼ é€’å’Œå¤„ç†é“¾ã€‚

import os, sys

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ°Pythonè·¯å¾„
# è®¡ç®—é¡¹ç›®æ ¹ç›®å½•è·¯å¾„
current_dir = os.path.dirname(os.path.abspath(__file__))
project_root = os.path.dirname(os.path.dirname(os.path.dirname(os.path.dirname(current_dir))))
print(f"Current directory: {current_dir}")
print(f"Project root: {project_root}")

if project_root not in sys.path:
    sys.path.insert(0, project_root)
    print(f"Added {project_root} to sys.path")

# éªŒè¯POæ¨¡å—æ˜¯å¦å­˜åœ¨
po_path = os.path.join(project_root, 'PO')
print(f"PO module path: {po_path}")
print(f"PO module exists: {os.path.exists(po_path)}")

from PO.TimePO import *
Time_PO = TimePO()

from airflow import DAG, Dataset
from airflow.operators.python import PythonOperator
from datetime import datetime as dt, timedelta
from airflow.providers.mysql.hooks.mysql import MySqlHook
from airflow.models import TaskInstance, DagRun
from airflow.utils.session import create_session
from airflow.configuration import conf
import importlib.util
import sys

from PO.OpenpyxlPO import *
Openpyxl_PO = OpenpyxlPO("/Users/linghuchong/Downloads/51/Python/project/instance/zyjk/CDRD/web/testcase.xlsx")

from PO.SqlserverPO import *




# æ‚£è€…å‘ç°
Sqlserver_PO = SqlserverPO("192.168.0.234", "sa", "Zy_123456789", "CDRD_TEST", "GBK")
# ===================== 1. å®šä¹‰ Dataset =====================
# ç”¨ URI å”¯ä¸€æ ‡è¯†æ•°æ®é›†ï¼ˆæ ¼å¼ï¼šdataset://<æ•°æ®æº>/<è¡¨å>ï¼Œè‡ªå®šä¹‰å³å¯ï¼‰
dataset_cdrd = Dataset(
    uri="dataset://cdrd/1p1n2t",
    extra={
        "description": "è®¢å•åŒæ­¥è¡¨ dw_orderï¼Œæ¥è‡ªä¸šåŠ¡åº“çš„è®¢å•æ•°æ®",
        "owner": "john",
        "version": "1.5"
    }
)

# å°è£…é€šç”¨è¯»å–å‡½æ•°
# def get_xcom(varDagId, varTaskId, **context):
#     """
#     ä»æŒ‡å®šç”Ÿäº§è€…/æ¶ˆè´¹è€…ä»»åŠ¡ä¸­è·å– XCom å€¼
#     ç”¨äºæ¶ˆè´¹è€…ä¹‹é—´çš„æ•°æ®ä¼ é€’
#     """
#     xcom_value = None
#
#     try:
#         with create_session() as session:
#             # æŸ¥æ‰¾æœ€æ–°çš„æˆåŠŸè¿è¡Œçš„æ¶ˆè´¹è€… DAG Run
#             latest_dag_run = session.query(DagRun).filter(
#                 DagRun.dag_id == varDagId,
#                 DagRun.state == "success"
#             ).order_by(DagRun.execution_date.desc()).first()
#
#             if latest_dag_run:
#                 # æŸ¥æ‰¾å¯¹åº”çš„ Task Instance
#                 ti = session.query(TaskInstance).filter(
#                     TaskInstance.dag_id == varDagId,
#                     TaskInstance.task_id == varTaskId,
#                     TaskInstance.run_id == latest_dag_run.run_id
#                 ).first()
#
#                 if ti:
#                     # ä» XCom ä¸­æ‹‰å–æ•°æ®
#                     xcom_value = ti.xcom_pull(task_ids=varTaskId, key="return_value")
#                     print(f"âœ… æˆåŠŸä»æ¶ˆè´¹è€… {varDagId}.{varTaskId} è·å– XCom å€¼: {xcom_value}")
#                 else:
#                     print("âš ï¸ æœªæ‰¾åˆ°å¯¹åº”çš„æ¶ˆè´¹è€… Task Instance")
#             else:
#                 print("âš ï¸ æœªæ‰¾åˆ°æˆåŠŸçš„æ¶ˆè´¹è€… DAG Run")
#     except Exception as e:
#         print(f"âŒ æŸ¥è¯¢æ¶ˆè´¹è€… XCom å¤±è´¥: {str(e)}")
#
#     return xcom_value

def get_xcom(varDagId, varTaskId, **context):
    """
    ä»æŒ‡å®šç”Ÿäº§è€…/æ¶ˆè´¹è€…ä»»åŠ¡ä¸­è·å– XCom å€¼
    ç”¨äºæ¶ˆè´¹è€…ä¹‹é—´çš„æ•°æ®ä¼ é€’
    """
    xcom_value = None

    try:
        with create_session() as session:
            # æŸ¥æ‰¾æœ€æ–°çš„æˆåŠŸè¿è¡Œçš„æ¶ˆè´¹è€… DAG Run
            latest_dag_run = session.query(DagRun).filter(
                DagRun.dag_id == varDagId,
                DagRun.state == "success"
            ).order_by(DagRun.execution_date.desc()).first()

            if latest_dag_run:
                # æŸ¥æ‰¾å¯¹åº”çš„ Task Instance
                ti = session.query(TaskInstance).filter(
                    TaskInstance.dag_id == varDagId,
                    TaskInstance.task_id == varTaskId,
                    TaskInstance.run_id == latest_dag_run.run_id
                ).first()

                if ti:
                    # ä» XCom ä¸­æ‹‰å–æ•°æ®
                    xcom_value = ti.xcom_pull(task_ids=varTaskId, key="return_value")
                    print(f"âœ… æˆåŠŸä»æ¶ˆè´¹è€… {varDagId}.{varTaskId} è·å– XCom å€¼: {xcom_value}")
                else:
                    print("âš ï¸ æœªæ‰¾åˆ°å¯¹åº”çš„æ¶ˆè´¹è€… Task Instance")
            else:
                print("âš ï¸ æœªæ‰¾åˆ°æˆåŠŸçš„æ¶ˆè´¹è€… DAG Run")
                # å°è¯•ä»å½“å‰è¿è¡Œçš„DAGä¸­è·å–XComå€¼
                if context and 'task_instance' in context:
                    current_ti = context['task_instance']
                    xcom_value = current_ti.xcom_pull(task_ids=varTaskId, dag_id=varDagId, key="return_value")
                    if xcom_value:
                        print(f"âœ… ä»å½“å‰è¿è¡Œä¸­è·å– XCom å€¼: {xcom_value}")
    except Exception as e:
        print(f"âŒ æŸ¥è¯¢æ¶ˆè´¹è€… XCom å¤±è´¥: {str(e)}")
        # æ·»åŠ æ›´å¤šè°ƒè¯•ä¿¡æ¯
        print(f"æ­£åœ¨æŸ¥è¯¢çš„DAG ID: {varDagId}, Task ID: {varTaskId}")

    return xcom_value

# ===================== ç”Ÿäº§è€… DAGï¼ˆæ›´æ–°æ•°æ®é›†+ å­˜å‚¨è¿”å›å€¼ï¼‰ =====================
# è¯¥ DAG æ‰§è¡Œåï¼Œä¼šæ ‡è®° dataset_cdrd ä¸º"å·²æ›´æ–°"
def p_cdrd_TASK(**context):
    shape = Openpyxl_PO.getL_shape("v1.0")
    l_col_values = []
    for i in range(shape[0]):
        if Openpyxl_PO.getCell(i + 1, 11, "v1.0") == "æ˜¯":
            l_col_value = []
            l_col_value.append(i + 1)
            l_col_value.append(Openpyxl_PO.getCell(i+1, 2, "v1.0"))  # æ¨¡å—
            l_col_value.append(Openpyxl_PO.getCell(i+1, 3, "v1.0"))  # å­æ¨¡å—
            l_col_value.append(Openpyxl_PO.getCell(i+1, 4, "v1.0"))  # å‰ç½®æ¡ä»¶
            l_col_value.append(Openpyxl_PO.getCell(i+1, 12, "v1.0"))  # è‡ªåŠ¨åŒ–æ•°æ®åº“æ ¡éªŒ
            l_col_value.append(Openpyxl_PO.getCell(i+1, 13, "v1.0"))  # è‡ªåŠ¨åŒ–è„šæœ¬
            l_col_values.append(l_col_value)


    return l_col_values
# ç”Ÿäº§è€… DAG
with DAG(
        dag_id="p_cdrd_all", start_date=dt(2026, 2, 13), schedule_interval=None,  # æ‰‹åŠ¨è§¦å‘ï¼ˆä¹Ÿå¯è®¾ä¸ºæ—¶é—´è°ƒåº¦ï¼Œå¦‚ "@daily"ï¼‰
        catchup=False, tags=["cdrd", "ç”Ÿäº§è€…"], render_template_as_native_obj=True
) as producer_dag:
    sync_task = PythonOperator(task_id="p_cdrd_TASK", python_callable=p_cdrd_TASK, outlets=[dataset_cdrd], provide_context=True)




def execute_playwright_script(file):
    file_path = f"/Users/linghuchong/Downloads/51/Python/project/instance/zyjk/CDRD/web/{file}"
    # åŠ¨æ€å¯¼å…¥æ¨¡å—
    spec = importlib.util.spec_from_file_location("playwright_script", file_path)
    module = importlib.util.module_from_spec(spec)
    # æ·»åŠ åˆ°ç³»ç»Ÿè·¯å¾„
    script_dir = os.path.dirname(file_path)
    if script_dir not in sys.path:
        sys.path.insert(0, script_dir)
    try:
        spec.loader.exec_module(module)
        # è°ƒç”¨æ¨¡å—ä¸­çš„å‡½æ•°å¹¶ä¼ é€’æµ‹è¯•æ•°æ®
        if hasattr(module, 'run_playwright'):
            result = module.run_playwright()
            # print(f"Playwright æ‰§è¡Œç»“æœ: {result}")
            return result
        else:
            print("æœªæ‰¾åˆ° run_playwright å‡½æ•°")
            return None
    except Exception as e:
        print(f"æ‰§è¡Œå¤±è´¥: {str(e)}")


# ===================== æ¶ˆè´¹è€…1 DAGï¼ˆç›‘å¬æ•°æ®é›† + è¯»å–ç”Ÿäº§è€… XComï¼‰ =====================
# è¯¥ DAG ç›‘å¬ dataset_1p2nï¼Œæ•°æ®æ›´æ–°æ—¶è‡ªåŠ¨è§¦å‘
def c_cdrd_TASK1(**context):
    # è¯»å–ç”Ÿäº§è€…çš„è¿”å›å€¼
    l_col_values = get_xcom("p_cdrd_all", "p_cdrd_TASK", **context)
    for i in range(len(l_col_values)):
        if l_col_values[i][1] == "ç³»ç»Ÿç®¡ç†" and l_col_values[i][2] == "ç”¨æˆ·ç®¡ç†":

            pathFile = os.path.join(l_col_values[i][1], l_col_values[i][2], l_col_values[i][5])
            result = execute_playwright_script(pathFile)
            # print(f"æœ€ç»ˆè¿”å›ç»“æœ: {result}") #  {'status': 'success', 'name': 'æ²™é¾™', 'phone': '13618714419', 'email': 'xiulan66@example.com', 'account': '377754', 'work_id': '769777'}

            def replace_variable(match):
                var_name = match.group(1)
                # ä»resultå­—å…¸ä¸­è·å–å¯¹åº”å€¼
                if isinstance(result, dict) and var_name in result:
                    return str(result[var_name])
                else:
                    # å¦‚æœæ‰¾ä¸åˆ°å¯¹åº”å€¼ï¼Œè¿”å›åŸå­—ç¬¦ä¸²
                    return match.group(0)

            formatted_string = re.sub(r"\{result\['([^']+)'\]\}", replace_variable, l_col_values[i][4])
            print(f"æ­£åˆ™æ›¿æ¢ç»“æœ: {formatted_string}")

            # å¦‚æœéœ€è¦evalæ‰§è¡ŒSQLæŸ¥è¯¢
            # å¦‚æœéœ€è¦evalæ‰§è¡ŒSQLæŸ¥è¯¢
            # try:
            #     d_validation = eval(formatted_string)
            #     print(f"è§£æåçš„éªŒè¯æ•°æ®: {d_validation}")
            #
            #     # æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢éªŒè¯
            #     if len(d_validation) == 1:
            #         l_d_ = Sqlserver_PO.select(d_validation[0]['k'])
            #         print(f"æŸ¥è¯¢ç»“æœ: {l_d_[0]['qty']}")
            #
            #         if l_d_[0]['qty'] == int(d_validation[0]['v']):
            #             print("âœ… æ–­è¨€é€šè¿‡")
            #             Openpyxl_PO.setCell(l_col_values[i][0], 10, "é€šè¿‡", "v1.0")
            #         else:
            #             print("âŒ æ–­è¨€å¤±è´¥")
            #             Openpyxl_PO.setCell(l_col_values[i][0], 10, "å¤±è´¥", "v1.0")
            #             Openpyxl_PO.setCell(l_col_values[i][0], 9, "v=" + str(l_d_[0]['qty']), "v1.0")
            #     elif len(d_validation) > 1:
            #         error = 0
            #         for j in range(len(d_validation)):
            #             l_d_ = Sqlserver_PO.select(d_validation[j]['k'])
            #             print(f"æŸ¥è¯¢ç»“æœ: {l_d_[0]['qty']}")
            #
            #             if l_d_[0]['qty'] == int(d_validation[j]['v']):
            #                 print("âœ… æ–­è¨€é€šè¿‡")
            #                 Openpyxl_PO.setCell(l_col_values[i][0], 10, "é€šè¿‡", "v1.0")
            #             else:
            #                 print("âŒ æ–­è¨€å¤±è´¥")
            #                 Openpyxl_PO.setCell(l_col_values[i][0], 10, "å¤±è´¥", "v1.0")
            #                 errorLog = str(d_validation[j]) + errorLog
            #                 error = 1
            #         if error == 1:
            #             Openpyxl_PO.setCell(l_col_values[i][0], 9, errorLog, "v1.0")
            #     else:
            #         print("error, è‡ªåŠ¨åŒ–æ ¡éªŒä¸èƒ½ä¸ºç©ºï¼")


            try:
                d_validation = eval(formatted_string)
                print(f"è§£æåçš„éªŒè¯æ•°æ®: {d_validation}")

                # æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢éªŒè¯
                l_d_ = Sqlserver_PO.select(d_validation['k1'])
                print(f"æŸ¥è¯¢ç»“æœ: {l_d_[0]['qty']}")

                if l_d_[0]['qty'] == int(d_validation['v1']):
                    print("âœ… æ–­è¨€é€šè¿‡")
                    Openpyxl_PO.setCell(l_col_values[i][0], 10, "é€šè¿‡", "v1.0")
                else:
                    print("âŒ æ–­è¨€å¤±è´¥")
                    Openpyxl_PO.setCell(l_col_values[i][0], 10, "å¤±è´¥", "v1.0")
                    Openpyxl_PO.setCell(l_col_values[i][0], 9, "v1=" + str(l_d_[0]['qty']), "v1.0")

            except Exception as e:
                print(f"éªŒè¯è¿‡ç¨‹å‡ºé”™: {e}")
# æ¶ˆè´¹è€…1 DAG
with DAG(
        dag_id="c_cdrd_DAG1", start_date=dt(2026, 2, 13), schedule=[dataset_cdrd], catchup=False,
        tags=["cdrd", "ç³»ç»Ÿç®¡ç†", "ç”¨æˆ·ç®¡ç†"], render_template_as_native_obj=True
) as consumer_dag:
    clean_task = PythonOperator(task_id="c_cdrd_TASK1", python_callable=c_cdrd_TASK1,
                                inlets=[dataset_cdrd], provide_context=True)



# ===================== æ¶ˆè´¹è€…2 DAGï¼ˆç›‘å¬æ•°æ®é›† + è¯»å–ç”Ÿäº§è€… XComï¼‰ =====================
def c_cdrd_TASK2(**context):
    l_col_values = get_xcom("p_cdrd_all", "p_cdrd_TASK", **context)
    for i in range(len(l_col_values)):
        if l_col_values[i][1] == "ç³»ç»Ÿç®¡ç†" and l_col_values[i][2] == "è§’è‰²ç®¡ç†":
            pathFile = os.path.join(l_col_values[i][1], l_col_values[i][2], l_col_values[i][5])

            result = execute_playwright_script(pathFile)
            print(f"æœ€ç»ˆè¿”å›ç»“æœ: {result}")

            def replace_variable(match):
                var_name = match.group(1)
                # ä»resultå­—å…¸ä¸­è·å–å¯¹åº”å€¼
                if isinstance(result, dict) and var_name in result:
                    return str(result[var_name])
                else:
                    # å¦‚æœæ‰¾ä¸åˆ°å¯¹åº”å€¼ï¼Œè¿”å›åŸå­—ç¬¦ä¸²
                    return match.group(0)

            formatted_string = re.sub(r"\{result\['([^']+)'\]\}", replace_variable, l_col_values[i][4])
            print(f"æ­£åˆ™æ›¿æ¢ç»“æœ: {formatted_string}")

            # å¦‚æœéœ€è¦evalæ‰§è¡ŒSQLæŸ¥è¯¢
            try:
                d_validation = eval(formatted_string)
                print(f"è§£æåçš„éªŒè¯æ•°æ®: {d_validation}")

                # æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢éªŒè¯
                if len(d_validation) == 1:
                    l_d_ = Sqlserver_PO.select(d_validation[0]['k'])
                    print(f"æŸ¥è¯¢ç»“æœ: {l_d_[0]['qty']}")

                    if l_d_[0]['qty'] == int(d_validation[0]['v']):
                        print("âœ… æ–­è¨€é€šè¿‡")
                        Openpyxl_PO.setCell(l_col_values[i][0], 10, "é€šè¿‡", "v1.0")
                    else:
                        print("âŒ æ–­è¨€å¤±è´¥")
                        Openpyxl_PO.setCell(l_col_values[i][0], 10, "å¤±è´¥", "v1.0")
                        Openpyxl_PO.setCell(l_col_values[i][0], 9, "v=" + str(l_d_[0]['qty']), "v1.0")
                elif len(d_validation) > 1:
                    error =0
                    for j in range(len(d_validation)):
                        l_d_ = Sqlserver_PO.select(d_validation[j]['k'])
                        print(f"æŸ¥è¯¢ç»“æœ: {l_d_[0]['qty']}")

                        if l_d_[0]['qty'] == int(d_validation[j]['v']):
                            print("âœ… æ–­è¨€é€šè¿‡")
                            Openpyxl_PO.setCell(l_col_values[i][0], 10, "é€šè¿‡", "v1.0")
                        else:
                            print("âŒ æ–­è¨€å¤±è´¥")
                            Openpyxl_PO.setCell(l_col_values[i][0], 10, "å¤±è´¥", "v1.0")
                            errorLog = str(d_validation[j]) + errorLog
                            error = 1
                    if error == 1:
                        Openpyxl_PO.setCell(l_col_values[i][0], 9, errorLog, "v1.0")
                else:
                    print("error, è‡ªåŠ¨åŒ–æ ¡éªŒä¸èƒ½ä¸ºç©ºï¼")

                # l_d_ = Sqlserver_PO.select(d_validation['k1'])
                # print(f"æŸ¥è¯¢ç»“æœ: {l_d_[0]['qty']}")
                #
                # if l_d_[0]['qty'] == int(d_validation['v1']):
                #     print("âœ… æ–­è¨€é€šè¿‡")
                #     Openpyxl_PO.setCell(l_col_values[i][0], 10, "é€šè¿‡", "v1.0")
                # else:
                #     print("âŒ æ–­è¨€å¤±è´¥")
                #     Openpyxl_PO.setCell(l_col_values[i][0], 10, "å¤±è´¥", "v1.0")
                #     Openpyxl_PO.setCell(l_col_values[i][0], 9, "v1=" + str(d_validation['value']), "v1.0")

            except Exception as e:
                print(f"éªŒè¯è¿‡ç¨‹å‡ºé”™: {e}")

# æ¶ˆè´¹è€…2 DAG
with DAG(
        dag_id="c_cdrd_DAG2", start_date=dt(2026, 2, 13), schedule=[dataset_cdrd], catchup=False,
        tags=["cdrd", "ç³»ç»Ÿç®¡ç†", "è§’è‰²ç®¡ç†"], render_template_as_native_obj=True
) as consumer2_dag:
    stat_task = PythonOperator(task_id="c_cdrd_TASK2", python_callable=c_cdrd_TASK2,
                               inlets=[dataset_cdrd], provide_context=True)


# ... existing code ...
# ===================== åè°ƒå™¨ DAGï¼ˆç­‰å¾…æ‰€æœ‰æ¶ˆè´¹è€…å®Œæˆåçš„æ”¶å°¾ä»»åŠ¡ï¼‰ =====================
def final_cleanup_task(**context):
    """
    åœ¨æ‰€æœ‰æ¶ˆè´¹è€…ä»»åŠ¡å®Œæˆåæ‰§è¡Œçš„æ”¶å°¾ä»»åŠ¡
    """
    print("ğŸš€ å¼€å§‹æ‰§è¡Œæ”¶å°¾ä»»åŠ¡...")

    try:
        # 1. ç»Ÿè®¡æµ‹è¯•ç»“æœ
        shape = Openpyxl_PO.getL_shape("v1.0")
        pass_count = 0
        fail_count = 0
        wait_count = 0
        stop_count = 0

        # è·å–"æ˜¯å¦è‡ªåŠ¨åŒ–"é‡Œ"æ˜¯"çš„æ•°é‡
        l_col_10 = Openpyxl_PO.getL_col(11,  "v1.0")
        count_10 = l_col_10.count("æ˜¯")

        for i in range(1, shape[0] + 1):
            status = Openpyxl_PO.getCell(i, 10, "v1.0")
            isAuto = Openpyxl_PO.getCell(i, 11, "v1.0")
            if isAuto == "æ˜¯":
                if status == "é€šè¿‡":
                    pass_count += 1
                elif status == "å¤±è´¥":
                    fail_count += 1
                elif status == "æš‚åœ":
                    wait_count += 1
                elif status == "æç½®":
                    stop_count += 1

        # print(f"ğŸ“Š æµ‹è¯•ç»Ÿè®¡ç»“æœ:")
        # print(f"   æ€»æµ‹è¯•æ•°: {count_10}")
        # print(f"   é€šè¿‡æ•°: {pass_count}")
        # print(f"   å¤±è´¥æ•°: {fail_count}")
        # print(f"   é€šè¿‡ç‡: {pass_count / (pass_count + fail_count) * 100:.2f}%" if (pass_count + fail_count) > 0 else "é€šè¿‡ç‡: 0%")

        # 2. ä¿å­˜æµ‹è¯•æŠ¥å‘Š
        # report_time = Time_PO.getTime("%Y-%m-%d %H:%M:%S")
        # Openpyxl_PO.setCell(1, 15, f"æµ‹è¯•æŠ¥å‘Šç”Ÿæˆæ—¶é—´: {report_time}", "v1.0")
        Openpyxl_PO.setCell(5, 4, f"è‡ªåŠ¨åŒ–æ•°é‡ï¼š{count_10}", "v1.0")
        Openpyxl_PO.setCell(4, 4, f"é€šè¿‡: {pass_count}ï¼Œå¤±è´¥: {fail_count}ï¼Œæš‚åœ: {wait_count}ï¼Œæç½®: {stop_count}", "v1.0")
        Openpyxl_PO.setCell(6, 4, f"è‡ªåŠ¨åŒ–é€šè¿‡ç‡: {pass_count / (pass_count + fail_count + wait_count + stop_count) * 100:.2f}%" if (pass_count + fail_count + wait_count + stop_count) > 0 else "é€šè¿‡ç‡: 0%", "v1.0")

        # 3. å‘é€é€šçŸ¥ï¼ˆå¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ é‚®ä»¶ã€ä¼ä¸šå¾®ä¿¡ç­‰é€šçŸ¥ï¼‰
        print("ğŸ“§ å‡†å¤‡å‘é€æµ‹è¯•ç»“æœé€šçŸ¥...")

        # 4. æ¸…ç†ä¸´æ—¶æ•°æ®æˆ–èµ„æº
        print("ğŸ§¹ æ¸…ç†ä¸´æ—¶èµ„æº...")

        # 5. è®°å½•æ—¥å¿—
        print("ğŸ“ è®°å½•æ‰§è¡Œæ—¥å¿—...")

        print("âœ… æ”¶å°¾ä»»åŠ¡æ‰§è¡Œå®Œæˆ!")

    except Exception as e:
        print(f"âŒ æ”¶å°¾ä»»åŠ¡æ‰§è¡Œå¤±è´¥: {str(e)}")
        raise e
# ===================== æ•´åˆç‰ˆ DAGï¼ˆç”Ÿäº§è€…+æ¶ˆè´¹è€…+æ”¶å°¾ä»»åŠ¡ï¼‰=====================
def integrated_workflow():
    """
    æ•´åˆçš„workflowï¼šç”Ÿäº§è€… â†’ æ¶ˆè´¹è€…1 + æ¶ˆè´¹è€…2 â†’ æ”¶å°¾ä»»åŠ¡
    """
    # ç”Ÿäº§è€…ä»»åŠ¡
    producer_result = p_cdrd_TASK()

    # æ¶ˆè´¹è€…ä»»åŠ¡å¹¶è¡Œæ‰§è¡Œ
    c_cdrd_TASK1()
    c_cdrd_TASK2()

    # æ”¶å°¾ä»»åŠ¡
    final_cleanup_task()


# æ•´åˆç‰ˆ DAG
with DAG(
        dag_id="integrated_cdrd_workflow",
        start_date=dt(2026, 2, 13),
        schedule_interval=None,
        catchup=False,
        tags=["cdrd", "æ•´åˆç‰ˆ"],
        render_template_as_native_obj=True
) as integrated_dag:
    # åˆ›å»ºä»»åŠ¡
    producer_task = PythonOperator(
        task_id="producer_task",
        python_callable=p_cdrd_TASK
    )

    consumer1_task = PythonOperator(
        task_id="consumer1_task",
        python_callable=c_cdrd_TASK1
    )

    consumer2_task = PythonOperator(
        task_id="consumer2_task",
        python_callable=c_cdrd_TASK2
    )

    cleanup_task = PythonOperator(
        task_id="cleanup_task",
        python_callable=final_cleanup_task
    )

    # è®¾ç½®ä¾èµ–å…³ç³»ï¼šç”Ÿäº§è€… â†’ æ¶ˆè´¹è€…ä»¬ â†’ æ”¶å°¾ä»»åŠ¡
    producer_task >> [consumer1_task, consumer2_task] >> cleanup_task


