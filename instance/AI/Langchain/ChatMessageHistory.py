# -*- coding: utf-8 -*-
# ChatMessageHistory.py (æœ€æ–°ç‰ˆæœ¬)

# ä½¿ç”¨æœ€æ–°çš„LangChainå¯¼å…¥æ–¹å¼
from langchain_community.chat_models.tongyi import ChatTongyi
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.messages import HumanMessage, AIMessage, SystemMessage
from langchain_core.chat_history import BaseChatMessageHistory
import os
from dotenv import load_dotenv

load_dotenv()


# è‡ªå®šä¹‰èŠå¤©å†å²ç±»ï¼ˆæ›¿ä»£ChatMessageHistoryï¼‰
class SimpleChatHistory(BaseChatMessageHistory):
    def __init__(self):
        self.messages = []

    def add_message(self, message):
        """æ·»åŠ æ¶ˆæ¯"""
        self.messages.append(message)

    def clear(self):
        """æ¸…ç©ºå†å²"""
        self.messages = []

# ä»ç¯å¢ƒå˜é‡è·å–APIå¯†é’¥
DASHSCOPE_API_KEY = os.getenv("DASHSCOPE_API_KEY")
if not DASHSCOPE_API_KEY:
    raise ValueError("è¯·åœ¨.envæ–‡ä»¶ä¸­è®¾ç½®DASHSCOPE_API_KEYç¯å¢ƒå˜é‡")


# åˆå§‹åŒ–Qwenæ¨¡å‹
llm = ChatTongyi(
    model_name="qwen-turbo",
    dashscope_api_key=DASHSCOPE_API_KEY
)

# åˆ›å»ºèŠå¤©å†å²å®ä¾‹
chat_history = SimpleChatHistory()

# ç³»ç»Ÿæç¤ºè¯
system_message = SystemMessage(content="ä½ æ˜¯ä¸€ä¸ª helpful çš„AIåŠ©æ‰‹ï¼Œä¼šè®°ä½æˆ‘ä»¬çš„å¯¹è¯å†å²ã€‚")

# Promptæ¨¡æ¿
prompt_template = ChatPromptTemplate.from_messages([
    ("system", "ä½ æ˜¯ä¸€ä¸ª helpful çš„AIåŠ©æ‰‹ï¼Œä¼šè®°ä½æˆ‘ä»¬çš„å¯¹è¯å†å²ã€‚"),
    ("placeholder", "{history}"),
    ("human", "{input}")
])


def chat_with_history(user_input):
    """å¸¦å†å²çš„èŠå¤©å‡½æ•°"""
    # æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°å†å²
    user_message = HumanMessage(content=user_input)
    chat_history.add_message(user_message)

    # æ„é€ å®Œæ•´çš„æ¶ˆæ¯åˆ—è¡¨
    messages = [system_message] + chat_history.messages

    # è°ƒç”¨æ¨¡å‹
    response = llm.invoke(messages)

    # æ·»åŠ AIå›å¤åˆ°å†å²
    ai_message = AIMessage(content=response.content)
    chat_history.add_message(ai_message)

    return response.content


# æµ‹è¯•å‡½æ•°
def run_chat_test():
    print("ğŸš€ èŠå¤©å†å²æµ‹è¯•")
    print("=" * 30)

    test_inputs = [
        "ä½ å¥½ï¼Œæˆ‘æ˜¯ä»¤ç‹å†²ï¼",
        "æˆ‘åˆšæ‰è¯´äº†ä»€ä¹ˆåå­—ï¼Ÿ",
        "è¯·ç®€æ´è¯„ä»·è¿™ä¸ªäººï¼Œä»–æ˜¯å“ªéƒ¨æ­¦ä¾ å°è¯´ä»»åŠ¡ï¼Ÿ"
    ]

    for i, user_input in enumerate(test_inputs, 1):
        print(f"\n--- ç¬¬{i}è½®å¯¹è¯ ---")
        print(f"ğŸ‘¤ ç”¨æˆ·: {user_input}")

        try:
            response = chat_with_history(user_input)
            print(f"ğŸ¤– åŠ©æ‰‹: {response}")
            print(f"ğŸ“Š å½“å‰å†å²æ¶ˆæ¯æ•°: {len(chat_history.messages)}")

        except Exception as e:
            print(f"âŒ å‡ºé”™: {e}")
            import traceback
            traceback.print_exc()
            break


# æŸ¥çœ‹å®Œæ•´å†å²
def show_full_history():
    print("\nğŸ“ å®Œæ•´å¯¹è¯å†å²:")
    print("=" * 30)
    for i, message in enumerate(chat_history.messages, 1):
        if isinstance(message, HumanMessage):
            print(f"{i}. ğŸ‘¤ ç”¨æˆ·: {message.content}")
        else:
            print(f"{i}. ğŸ¤– åŠ©æ‰‹: {message.content}")


if __name__ == "__main__":
    run_chat_test()
    show_full_history()



# /Users/linghuchong/miniconda3/envs/py311/bin/python /Users/linghuchong/Downloads/51/Python/project/instance/AI/Langchain/ChatMessageHistory.py
# ğŸš€ èŠå¤©å†å²æµ‹è¯•
# ==============================
#
# --- ç¬¬1è½®å¯¹è¯ ---
# ğŸ‘¤ ç”¨æˆ·: ä½ å¥½ï¼Œæˆ‘æ˜¯å¼ ä¸‰ï¼
# ğŸ¤– åŠ©æ‰‹: ä½ å¥½ï¼Œå¼ ä¸‰ï¼å¾ˆé«˜å…´è®¤è¯†ä½ ã€‚æˆ‘æ˜¯é€šä¹‰åƒé—®ï¼Œä¸€ä¸ªç”±é˜¿é‡Œå·´å·´é›†å›¢å¼€å‘çš„å¤§å‹è¯­è¨€æ¨¡å‹ã€‚æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®ä½ çš„å—ï¼Ÿ
# ğŸ“Š å½“å‰å†å²æ¶ˆæ¯æ•°: 2
#
# --- ç¬¬2è½®å¯¹è¯ ---
# ğŸ‘¤ ç”¨æˆ·: æˆ‘åˆšæ‰è¯´äº†ä»€ä¹ˆåå­—ï¼Ÿ
# ğŸ¤– åŠ©æ‰‹: ä½ åˆšæ‰è¯´ä½ çš„åå­—æ˜¯å¼ ä¸‰ã€‚
# ğŸ“Š å½“å‰å†å²æ¶ˆæ¯æ•°: 4
#
# --- ç¬¬3è½®å¯¹è¯ ---
# ğŸ‘¤ ç”¨æˆ·: æˆ‘å–œæ¬¢ç¼–ç¨‹ï¼Œä½ å‘¢ï¼Ÿ
# ğŸ¤– åŠ©æ‰‹: æˆ‘ä¹Ÿéå¸¸å–œæ¬¢ç¼–ç¨‹ï¼è™½ç„¶æˆ‘æ˜¯ä¸€ä¸ªè¯­è¨€æ¨¡å‹ï¼Œä¸èƒ½åƒäººç±»ä¸€æ ·å®é™…ç¼–å†™ä»£ç ï¼Œä½†æˆ‘å¯ä»¥å¸®åŠ©ä½ è§£å†³é—®é¢˜ã€è§£é‡Šç¼–ç¨‹æ¦‚å¿µï¼Œç”šè‡³å¸®ä½ å†™ä¸€äº›ä»£ç ã€‚ä½ å–œæ¬¢å“ªç§ç¼–ç¨‹è¯­è¨€å‘¢ï¼Ÿæˆ–è€…æœ‰ä»€ä¹ˆå…·ä½“çš„ç¼–ç¨‹é—®é¢˜éœ€è¦å¸®åŠ©å—ï¼Ÿ
# ğŸ“Š å½“å‰å†å²æ¶ˆæ¯æ•°: 6
#
# --- ç¬¬4è½®å¯¹è¯ ---
# ğŸ‘¤ ç”¨æˆ·: å›é¡¾ä¸€ä¸‹æˆ‘ä»¬èŠäº†ä»€ä¹ˆï¼Ÿ
# ğŸ¤– åŠ©æ‰‹: æˆ‘ä»¬ä¹‹å‰çš„å¯¹è¯å†…å®¹å¦‚ä¸‹ï¼š
#
# 1. ä½ å‘æˆ‘æ‰“æ‹›å‘¼ï¼Œè¯´ï¼šâ€œä½ å¥½ï¼Œæˆ‘æ˜¯å¼ ä¸‰ï¼â€
# 2. æˆ‘å›åº”ä½ ï¼Œå¹¶ä»‹ç»è‡ªå·±æ˜¯é€šä¹‰åƒé—®ã€‚
# 3. ä½ é—®ï¼šâ€œæˆ‘åˆšæ‰è¯´äº†ä»€ä¹ˆåå­—ï¼Ÿâ€
# 4. æˆ‘å›ç­”ï¼šâ€œä½ åˆšæ‰è¯´ä½ çš„åå­—æ˜¯å¼ ä¸‰ã€‚â€
# 5. ä½ é—®ï¼šâ€œæˆ‘å–œæ¬¢ç¼–ç¨‹ï¼Œä½ å‘¢ï¼Ÿâ€
# 6. æˆ‘å›ç­”ï¼šâ€œæˆ‘ä¹Ÿéå¸¸å–œæ¬¢ç¼–ç¨‹ï¼è™½ç„¶æˆ‘æ˜¯ä¸€ä¸ªè¯­è¨€æ¨¡å‹ï¼Œä¸èƒ½åƒäººç±»ä¸€æ ·å®é™…ç¼–å†™ä»£ç ï¼Œä½†æˆ‘å¯ä»¥å¸®åŠ©ä½ è§£å†³é—®é¢˜ã€è§£é‡Šç¼–ç¨‹æ¦‚å¿µï¼Œç”šè‡³å¸®ä½ å†™ä¸€äº›ä»£ç ã€‚ä½ å–œæ¬¢å“ªç§ç¼–ç¨‹è¯­è¨€å‘¢ï¼Ÿæˆ–è€…æœ‰ä»€ä¹ˆå…·ä½“çš„ç¼–ç¨‹é—®é¢˜éœ€è¦å¸®åŠ©å—ï¼Ÿâ€
#
# å¦‚æœä½ è¿˜æœ‰å…¶ä»–é—®é¢˜æˆ–éœ€è¦è¿›ä¸€æ­¥çš„å¸®åŠ©ï¼Œè¯·éšæ—¶å‘Šè¯‰æˆ‘ï¼
# ğŸ“Š å½“å‰å†å²æ¶ˆæ¯æ•°: 8
#
# ğŸ“ å®Œæ•´å¯¹è¯å†å²:
# ==============================
# 1. ğŸ‘¤ ç”¨æˆ·: ä½ å¥½ï¼Œæˆ‘æ˜¯å¼ ä¸‰ï¼
# 2. ğŸ¤– åŠ©æ‰‹: ä½ å¥½ï¼Œå¼ ä¸‰ï¼å¾ˆé«˜å…´è®¤è¯†ä½ ã€‚æˆ‘æ˜¯é€šä¹‰åƒé—®ï¼Œä¸€ä¸ªç”±é˜¿é‡Œå·´å·´é›†å›¢å¼€å‘çš„å¤§å‹è¯­è¨€æ¨¡å‹ã€‚æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®ä½ çš„å—ï¼Ÿ
# 3. ğŸ‘¤ ç”¨æˆ·: æˆ‘åˆšæ‰è¯´äº†ä»€ä¹ˆåå­—ï¼Ÿ
# 4. ğŸ¤– åŠ©æ‰‹: ä½ åˆšæ‰è¯´ä½ çš„åå­—æ˜¯å¼ ä¸‰ã€‚
# 5. ğŸ‘¤ ç”¨æˆ·: æˆ‘å–œæ¬¢ç¼–ç¨‹ï¼Œä½ å‘¢ï¼Ÿ
# 6. ğŸ¤– åŠ©æ‰‹: æˆ‘ä¹Ÿéå¸¸å–œæ¬¢ç¼–ç¨‹ï¼è™½ç„¶æˆ‘æ˜¯ä¸€ä¸ªè¯­è¨€æ¨¡å‹ï¼Œä¸èƒ½åƒäººç±»ä¸€æ ·å®é™…ç¼–å†™ä»£ç ï¼Œä½†æˆ‘å¯ä»¥å¸®åŠ©ä½ è§£å†³é—®é¢˜ã€è§£é‡Šç¼–ç¨‹æ¦‚å¿µï¼Œç”šè‡³å¸®ä½ å†™ä¸€äº›ä»£ç ã€‚ä½ å–œæ¬¢å“ªç§ç¼–ç¨‹è¯­è¨€å‘¢ï¼Ÿæˆ–è€…æœ‰ä»€ä¹ˆå…·ä½“çš„ç¼–ç¨‹é—®é¢˜éœ€è¦å¸®åŠ©å—ï¼Ÿ
# 7. ğŸ‘¤ ç”¨æˆ·: å›é¡¾ä¸€ä¸‹æˆ‘ä»¬èŠäº†ä»€ä¹ˆï¼Ÿ
# 8. ğŸ¤– åŠ©æ‰‹: æˆ‘ä»¬ä¹‹å‰çš„å¯¹è¯å†…å®¹å¦‚ä¸‹ï¼š
#
# 1. ä½ å‘æˆ‘æ‰“æ‹›å‘¼ï¼Œè¯´ï¼šâ€œä½ å¥½ï¼Œæˆ‘æ˜¯å¼ ä¸‰ï¼â€
# 2. æˆ‘å›åº”ä½ ï¼Œå¹¶ä»‹ç»è‡ªå·±æ˜¯é€šä¹‰åƒé—®ã€‚
# 3. ä½ é—®ï¼šâ€œæˆ‘åˆšæ‰è¯´äº†ä»€ä¹ˆåå­—ï¼Ÿâ€
# 4. æˆ‘å›ç­”ï¼šâ€œä½ åˆšæ‰è¯´ä½ çš„åå­—æ˜¯å¼ ä¸‰ã€‚â€
# 5. ä½ é—®ï¼šâ€œæˆ‘å–œæ¬¢ç¼–ç¨‹ï¼Œä½ å‘¢ï¼Ÿâ€
# 6. æˆ‘å›ç­”ï¼šâ€œæˆ‘ä¹Ÿéå¸¸å–œæ¬¢ç¼–ç¨‹ï¼è™½ç„¶æˆ‘æ˜¯ä¸€ä¸ªè¯­è¨€æ¨¡å‹ï¼Œä¸èƒ½åƒäººç±»ä¸€æ ·å®é™…ç¼–å†™ä»£ç ï¼Œä½†æˆ‘å¯ä»¥å¸®åŠ©ä½ è§£å†³é—®é¢˜ã€è§£é‡Šç¼–ç¨‹æ¦‚å¿µï¼Œç”šè‡³å¸®ä½ å†™ä¸€äº›ä»£ç ã€‚ä½ å–œæ¬¢å“ªç§ç¼–ç¨‹è¯­è¨€å‘¢ï¼Ÿæˆ–è€…æœ‰ä»€ä¹ˆå…·ä½“çš„ç¼–ç¨‹é—®é¢˜éœ€è¦å¸®åŠ©å—ï¼Ÿâ€
#
# å¦‚æœä½ è¿˜æœ‰å…¶ä»–é—®é¢˜æˆ–éœ€è¦è¿›ä¸€æ­¥çš„å¸®åŠ©ï¼Œè¯·éšæ—¶å‘Šè¯‰æˆ‘ï¼
#
# Process finished with exit code 0