ä»¥ä¸‹æ˜¯ä½¿ç”¨ Selenium å®ç° Cookie é‰´æƒè‡ªåŠ¨åŒ– çš„å®Œæ•´å®æˆ˜æ–¹æ¡ˆï¼ŒåŒ…å«ç™»å½•æ€ä¿å­˜ã€å¤ç”¨ã€å¼‚å¸¸å¤„ç†ç­‰åœºæ™¯ï¼Œé™„å¯ç›´æ¥è¿è¡Œçš„ä»£ç ç¤ºä¾‹ï¼š
# todo ä¸€ã€æ ¸å¿ƒæµç¨‹ï¼šCookie é‰´æƒä¸‰æ­¥éª¤
é¦–æ¬¡ç™»å½•

è·å–å¹¶ä¿å­˜Cookie

ä¸‹æ¬¡å¯åŠ¨æ—¶åŠ è½½Cookie

éªŒè¯é‰´æƒçŠ¶æ€



# todo äºŒã€å®æˆ˜æ¡ˆä¾‹ï¼šæ¨¡æ‹ŸçŸ¥ä¹è‡ªåŠ¨ç™»å½•ï¼ˆå…è´¦å·å¯†ç ï¼‰
åœºæ™¯è¯´æ˜ï¼š
é¦–æ¬¡è¿è¡Œæ—¶æ‰‹åŠ¨ç™»å½•ï¼Œä¿å­˜ Cookie åˆ°æœ¬åœ°
åç»­è¿è¡Œç›´æ¥åŠ è½½ Cookieï¼Œè·³è¿‡ç™»å½•æµç¨‹
æ”¯æŒ Cookie è¿‡æœŸè‡ªåŠ¨è§¦å‘é‡æ–°ç™»å½•
å®Œæ•´ä»£ç ï¼š
python
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
import json
import time

class ZhihuAutoAuth:
    def __init__(self, cookie_path="zhihu_cookies.json"):
        self.driver = webdriver.Chrome()
        self.cookie_path = cookie_path
        self.base_url = "https://www.zhihu.com"
        self.login_url = f"{self.base_url}/signin"
        self.user_home_xpath = '//div[@class="UserProfileHeader"]//a[contains(@href, "/people/")]'

    def _save_cookies(self):
        """ä¿å­˜å½“å‰ä¼šè¯çš„Cookieåˆ°æ–‡ä»¶"""
        with open(self.cookie_path, "w") as f:
            json.dump(self.driver.get_cookies(), f)
        print(f"âœ… Cookieå·²ä¿å­˜åˆ° {self.cookie_path}")

    def _load_cookies(self):
        """ä»æ–‡ä»¶åŠ è½½Cookieå¹¶æ³¨å…¥æµè§ˆå™¨"""
        try:
            with open(self.cookie_path, "r") as f:
                cookies = json.load(f)
                # è¿‡æ»¤æ— æ•ˆCookieï¼ˆå¦‚è¿‡æœŸæˆ–éå½“å‰åŸŸï¼‰
                valid_cookies = [c for c in cookies if c.get('domain') in self.base_url]
                for cookie in valid_cookies:
                    # å¤„ç†Expiryæ—¶é—´ï¼ˆSeleniumè¦æ±‚intç±»å‹ï¼‰
                    if 'expiry' in cookie and isinstance(cookie['expiry'], float):
                        cookie['expiry'] = int(cookie['expiry'])
                    self.driver.add_cookie(cookie)
                print(f"âœ… åŠ è½½{len(valid_cookies)}ä¸ªæœ‰æ•ˆCookie")
                return True
        except FileNotFoundError:
            print("âŒ æœªæ‰¾åˆ°Cookieæ–‡ä»¶ï¼Œéœ€æ‰‹åŠ¨ç™»å½•")
            return False

    def _is_logged_in(self):
        """éªŒè¯æ˜¯å¦å·²ç™»å½•ï¼ˆé€šè¿‡ç”¨æˆ·å¤´åƒå…ƒç´ å­˜åœ¨æ€§ï¼‰"""
        try:
            WebDriverWait(self.driver, 5).until(
                EC.presence_of_element_located((By.XPATH, self.user_home_xpath))
            )
            return True
        except:
            return False

    def auth(self, force_login=False):
        """è‡ªåŠ¨é‰´æƒä¸»æµç¨‹"""
        self.driver.get(self.base_url)

        # å°è¯•åŠ è½½æœ¬åœ°Cookieï¼ˆéå¼ºåˆ¶ç™»å½•æ—¶ï¼‰
        if not force_login and self._load_cookies():
            self.driver.refresh()  # åˆ·æ–°é¡µé¢ä½¿Cookieç”Ÿæ•ˆ
            if self._is_logged_in():
                print("ğŸ‰ å·²é€šè¿‡Cookieè‡ªåŠ¨ç™»å½•")
                return

        # è§¦å‘æ‰‹åŠ¨ç™»å½•æµç¨‹
        print("ğŸ”‘ å¼€å§‹æ‰‹åŠ¨ç™»å½•ï¼ˆè¯·åœ¨30ç§’å†…å®Œæˆï¼‰")
        self.driver.get(self.login_url)
        WebDriverWait(self.driver, 30).until(
            EC.url_changes(self.login_url)  # ç­‰å¾…ç™»å½•æˆåŠŸè·³è½¬
        )

        # ä¿å­˜æ–°Cookie
        if self._is_logged_in():
            self._save_cookies()
        else:
            raise Exception("âŒ ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥è´¦å·å¯†ç ")

    def close(self):
        self.driver.quit()

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    auth = ZhihuAutoAuth()
    try:
        auth.auth()  # é¦–æ¬¡è¿è¡Œéœ€æ‰‹åŠ¨ç™»å½•ï¼Œåç»­è‡ªåŠ¨å¤ç”¨Cookie
        # æ‰§è¡Œéœ€è¦ç™»å½•çš„æ“ä½œï¼ˆä¾‹å¦‚è®¿é—®ä¸ªäººä¸»é¡µï¼‰
        auth.driver.get(f"{auth.base_url}/people/your-username")
        time.sleep(3)  # æ¼”ç¤ºåœç•™
    finally:
        auth.close()
ä¸‰ã€å…³é”®æŠ€æœ¯è§£æ
1. Cookie æŒä¹…åŒ–å­˜å‚¨
ä¿å­˜æ ¼å¼ï¼šä½¿ç”¨ JSON å­˜å‚¨åŸå§‹ Cookie æ•°æ®ï¼ˆåŒ…å« domainã€pathã€expiry ç­‰å®Œæ•´ä¿¡æ¯ï¼‰
è¿‡æ»¤é€»è¾‘ï¼šåªä¿ç•™å½“å‰åŸŸï¼ˆ.zhihu.comï¼‰çš„æœ‰æ•ˆ Cookieï¼Œé¿å…è·¨åŸŸæ±¡æŸ“
æ—¶é—´å¤„ç†ï¼šå°† Cookie çš„ expiryï¼ˆè¿‡æœŸæ—¶é—´ï¼‰è½¬æ¢ä¸ºæ•´æ•°ï¼ˆSelenium è¦æ±‚ï¼‰
2. åŠ¨æ€éªŒè¯ç™»å½•çŠ¶æ€
å…ƒç´ å®šä½ï¼šé€šè¿‡ç”¨æˆ·å¤´åƒçš„ XPathï¼ˆUserProfileHeader ç±»ï¼‰åˆ¤æ–­ç™»å½•æ€
æ˜¾å¼ç­‰å¾…ï¼šä½¿ç”¨ WebDriverWait é¿å…å› ç½‘ç»œå»¶è¿Ÿå¯¼è‡´çš„è¯¯åˆ¤
3. å¼‚å¸¸å¤„ç†ä¸å…¼å®¹
å¼ºåˆ¶ç™»å½•ï¼šé€šè¿‡ force_login=True å‚æ•°å¼ºåˆ¶é‡æ–°è·å– Cookieï¼ˆç”¨äºè¿‡æœŸåœºæ™¯ï¼‰
æ–‡ä»¶ä¸å­˜åœ¨ï¼šé¦–æ¬¡è¿è¡Œæ—¶è‡ªåŠ¨è¿›å…¥æ‰‹åŠ¨ç™»å½•æµç¨‹
Cookie è¿‡æœŸï¼šåˆ·æ–°é¡µé¢åè‹¥æ£€æµ‹åˆ°æœªç™»å½•ï¼Œè‡ªåŠ¨è§¦å‘é‡æ–°ç™»å½•
å››ã€è¿›é˜¶æŠ€å·§ï¼šå¤šåœºæ™¯é€‚é…
åœºæ™¯ 1ï¼šå•é¡µé¢åº”ç”¨ï¼ˆSPAï¼‰çš„ Cookie æ³¨å…¥
python
# é’ˆå¯¹ Vue/React ç­‰å‰ç«¯è·¯ç”±ï¼Œéœ€ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆ
def _load_cookies(self):
    super()._load_cookies()
    self.driver.execute_script("window.dispatchEvent(new Event('cookieUpdated'))")  # è§¦å‘å‰ç«¯ Cookie ç›‘å¬
    WebDriverWait(self.driver, 10).until(
        EC.presence_of_element_located((By.ID, "app"))  # ç­‰å¾… SPA æ¸²æŸ“
    )
åœºæ™¯ 2ï¼šHttpOnly Cookie å¤„ç†
é™åˆ¶ï¼šSelenium æ— æ³•ç›´æ¥æ“ä½œ HttpOnly ç±»å‹çš„ Cookieï¼ˆæµè§ˆå™¨å®‰å…¨ç­–ç•¥ï¼‰
è§£å†³æ–¹æ¡ˆï¼šé€šè¿‡æµè§ˆå™¨æ’ä»¶æˆ–ä»£ç†æŠ“åŒ…è·å–ï¼ˆéœ€é…åˆ Charles/Fiddlerï¼‰
åœºæ™¯ 3ï¼šå¤šè´¦å· Cookie éš”ç¦»
python
# æŒ‰è´¦å·ååŒºåˆ† Cookie æ–‡ä»¶
class MultiAccountAuth(ZhihuAutoAuth):
    def __init__(self, username):
        super().__init__(cookie_path=f"zhihu_{username}_cookies.json")
äº”ã€æ³¨æ„äº‹é¡¹
Cookie æœ‰æ•ˆæœŸï¼š
å®šæœŸæ£€æŸ¥ Cookie è¿‡æœŸæ—¶é—´ï¼ˆexpiry å­—æ®µï¼‰ï¼Œå»ºè®®é…åˆå®šæ—¶ä»»åŠ¡è‡ªåŠ¨æ›´æ–°
æ•æ„Ÿä¸šåŠ¡ï¼ˆå¦‚æ”¯ä»˜ï¼‰é¿å…é•¿æœŸå¤ç”¨ Cookieï¼Œä¼˜å…ˆä½¿ç”¨ Token é‰´æƒ
å®‰å…¨å­˜å‚¨ï¼š
é¿å…æ˜æ–‡ä¿å­˜ Cookie æ–‡ä»¶ï¼Œç”Ÿäº§ç¯å¢ƒå¯åŠ å¯†å­˜å‚¨ï¼ˆå¦‚ä½¿ç”¨ cryptography åº“ï¼‰
é™åˆ¶ Cookie æ–‡ä»¶çš„è®¿é—®æƒé™ï¼ˆLinux ä¸‹ chmod 600 cookies.jsonï¼‰
æµè§ˆå™¨å…¼å®¹æ€§ï¼š
ä¸åŒæµè§ˆå™¨çš„ Cookie ä¸é€šç”¨ï¼ˆChrome/Firefox éœ€å•ç‹¬ä¿å­˜ï¼‰
å»ºè®®å›ºå®šæµè§ˆå™¨ç‰ˆæœ¬ï¼ˆé€šè¿‡ webdriver-manager ç®¡ç†é©±åŠ¨ï¼‰
åçˆ¬é£æ§ï¼š
é¢‘ç¹å¤ç”¨ Cookie å¯èƒ½è§¦å‘é£æ§ï¼Œå»ºè®®æ¨¡æ‹Ÿäººç±»è¡Œä¸ºï¼ˆå¦‚éšæœºå»¶è¿Ÿã€ä¸åŒ UAï¼‰
é…åˆ IP ä»£ç†æ± ä½¿ç”¨ï¼ˆé’ˆå¯¹ä¸¥æ ¼é£æ§çš„ç½‘ç«™ï¼‰
å…­ã€éªŒè¯æ–¹æ³•ï¼šæ£€æŸ¥ Cookie æ˜¯å¦ç”Ÿæ•ˆ
æµè§ˆå™¨æ§åˆ¶å°éªŒè¯ï¼š
javascript
// ç™»å½•åæ‰§è¡Œï¼Œç¡®è®¤ Cookie åŒ…å«è®¤è¯ä¿¡æ¯
document.cookie.split('; ').forEach(c => console.log(c));
// é¢„æœŸåŒ…å«ï¼šz_c0ï¼ˆçŸ¥ä¹ç”¨æˆ·æ ‡è¯†ï¼‰ã€d_c0ï¼ˆè®¾å¤‡æŒ‡çº¹ï¼‰ç­‰

æ¥å£éªŒè¯ï¼ˆé…åˆ Requestsï¼‰ï¼š
python
import requests
headers = {"Cookie": "your_cookie_string"}
res = requests.get("https://www.zhihu.com/api/v4/me", headers=headers)
assert res.status_code == 200, "Cookie æ— æ•ˆ"

é€šè¿‡ä»¥ä¸Šæ–¹æ¡ˆï¼Œå¯å®ç° 90% ä»¥ä¸Š Web ç³»ç»Ÿçš„ Cookie é‰´æƒè‡ªåŠ¨åŒ–ï¼Œå‡å°‘é‡å¤ç™»å½•æ“ä½œï¼Œæå‡è‡ªåŠ¨åŒ–è„šæœ¬çš„ç¨³å®šæ€§å’Œæ‰§è¡Œæ•ˆç‡ã€‚å®é™…ä½¿ç”¨ä¸­éœ€æ ¹æ®ç›®æ ‡ç½‘ç«™çš„ Cookie æœºåˆ¶ï¼ˆå¦‚ SameSiteã€Secure æ ‡è®°ï¼‰è°ƒæ•´ç­–ç•¥ã€‚
